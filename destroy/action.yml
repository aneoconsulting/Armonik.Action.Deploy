name: "Destroy ArmoniK"
description: "Action to destroy ArmoniK deployment"
inputs:
  type:
    description: 'Type of deployment ("aws", "localhost" and "gcp")'
    required: true
  prefix:
    description: "Prefix for the deployment"
    required: false
    default: "armonik-cicd"
  working-directory:
    description: "Working directory (should be the ArmoniK repo root folder)"
    required: false
    default: ${{ github.workspace }}
  parameters-file-path:
    description: "Relative path for the Terraform configuration file, root being the ArmoniK repository. Empty keeps it to the default parameters.tfvars associated with your deployment type"
    required: false
    default: ""

runs:
  using: composite
  steps:
    - id: destroy
      name: Destroy
      working-directory: ${{ inputs.working-directory }}
      shell: bash
      env:
        INPUT_TYPE: ${{ inputs.type }}
        INPUT_PREFIX: ${{ inputs.prefix }}
        PARAMETERS_FILE_PATH: ${{ inputs.parameters-file-path }}
      run: |
        set -ex
        if [ -n "$PARAMETERS_FILE_PATH" ]; then
          export PARAMETERS_FILE="$(pwd)/$PARAMETERS_FILE_PATH"
        fi

        cd infrastructure/quick-deploy/
        cd "$INPUT_TYPE"
        make PREFIX="$INPUT_PREFIX" get-modules
        make PREFIX="$INPUT_PREFIX" init
        make PREFIX="$INPUT_PREFIX" output

        if [ "$INPUT_TYPE" = "aws" ]; then
          EKS_NAME="$(jq -r .eks.name generated/armonik-output.json)"
          EKS_REGION="$(jq -r .eks.region generated/armonik-output.json)"
          if [ "${EKS_NAME:-null}" != null ] && [ "${EKS_REGION:-null}" != null ]; then
            aws eks update-kubeconfig --region "$EKS_REGION" --name "$EKS_NAME"
            cat ~/.kube/config
          else 
            # Ignore the update-kubeconfig if there is no EKS
            TF_DATA_DIR=generated terraform state rm module.eks.null_resource.update_kubeconfig > /dev/null 2>&1 || true
          fi

        elif [ "$INPUT_TYPE" = "gcp" ]; then
          GKE_NAME="$(jq -r .gke.name generated/armonik-output.json)"
          GKE_LOCATION="$(jq -r .gke.region generated/armonik-output.json)"
          if [ "${GKE_NAME:-null}" != null ] && [ "${GKE_LOCATION:-null}" != null ]; then
            gcloud container clusters get-credentials "$GKE_NAME" --location "$GKE_LOCATION"
            cat ~/.kube/config
          else 
            # Ignore the update-kubeconfig if there is no GKE
            TF_DATA_DIR=generated terraform state rm module.gke.null_resource.update_kubeconfig > /dev/null 2>&1 || true
          fi
        fi

        make PREFIX="$INPUT_PREFIX" delete
